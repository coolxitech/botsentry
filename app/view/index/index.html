<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{$serverName} - 进服验证</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        window.AliyunCaptchaConfig = {
            region: "cn",
            prefix: "{$aliyun['params']['prefix']}"
        };
    </script>
    <script type="text/javascript" src="https://o.alicdn.com/captcha-frontend/aliyunCaptcha/AliyunCaptcha.js"></script>
    <style>
        body,html{height:100%;margin:0;overflow:hidden;background:linear-gradient(-45deg,#0f0c29,#302b63,#24243e);font-family:'Microsoft YaHei',sans-serif}
        #particles-js{position:absolute;width:100%;height:100%;background:transparent}
        .card{background:rgba(255,255,255,0.11);backdrop-filter:blur(22px);border-radius:30px;border:1px solid rgba(255,255,255,0.3);
            box-shadow:0 20px 60px rgba(0,0,0,0.8);max-width:540px;position:relative;overflow:hidden;}
        .card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
            background:linear-gradient(45deg,transparent,rgba(138,43,226,0.3),transparent);animation:flow 8s linear infinite;}
        @keyframes flow{0%{transform:translateX(-100%) translateY(-100%) rotate(25deg)}100%{transform:translateX(100%) translateY(100%) rotate(25deg)}}
        .title{font-family:'Minecraft',sans-serif;color:#8A2BE2;text-shadow:0 0 20px #8A2BE2;letter-spacing:8px}
        .server{background:linear-gradient(90deg,#00ffea,#ff00ff,#8A2BE2);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
            font-size:2.8rem;font-weight:bold;animation:glow 6s ease infinite;}
        @keyframes glow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        .success-box{background:rgba(0,255,100,0.2);border:2px solid #00ff9d;border-radius:20px;padding:35px;margin-top:30px;
            color:#00ff9d;font-size:1.7rem;text-shadow:0 0 20px #00ff9d;animation:pulse 2s infinite;}
        .error-box{background:rgba(255,50,50,0.2);border:2px solid #ff4466;border-radius:20px;padding:25px;margin-top:30px;
            color:#ff6677;font-size:1.4rem;text-shadow:0 0 15px #ff0000;animation:pulseError 2s infinite;}
        @keyframes pulse{0%,100%{box-shadow:0 0 20px #00ff9d}50%{box-shadow:0 0 50px #00ff9d}}
        @keyframes pulseError{0%,100%{box-shadow:0 0 20px #ff4466}50%{box-shadow:0 0 50px #ff0000}}
        #captcha-box{min-height:100px;display:flex;justify-content:center;align-items:center;}
    </style>
</head>
<body>

<div id="app">
    <div id="particles-js"></div>
    <div class="h-100 d-flex align-items-center justify-content-center">
        <div class="card p-5 text-center animate__animated animate__zoomIn">
            <h1 class="title display-4 mb-4">MINECRAFT</h1>
            <h2 class="server mb-4">{{ serverName }}</h2>
            <p class="text-white-70 fs-5 mb-5">请完成下方人机验证后进入服务器</p>

            <div id="captcha-box" class="mb-4">
                <div class="spinner-border text-light" style="width:3rem;height:3rem;" v-if="loading"></div>
            </div>

            <!-- 成功提示 -->
            <transition name="fade">
                <div v-if="verified" class="success-box animate__animated animate__tada">
                    <h3>✓ 已通过人机验证！</h3>
                    <p class="mt-3 mb-0 fs-4" v-if="typeof countdown === 'number'">{{ countdown }} 秒后可关闭窗口</p>
                    <p class="mt-3 mb-0 fs-4" v-if="typeof countdown === 'string'">{{ countdown }}</p>
                    <small class="text-white-50">验证成功，祝你游戏愉快！</small>
                </div>
            </transition>

            <!-- 错误提示（新增） -->
            <transition name="fade">
                <div v-if="errorMsg" class="error-box animate__animated animate__shakeX">
                    <h4>⚠️ 验证失败</h4>
                    <p class="mb-0">{{ errorMsg }}</p>
                    <button @click="retryCaptcha" class="btn btn-outline-light btn-sm mt-3">重新验证</button>
                </div>
            </transition>

            <div class="text-white-50 small mt-4">当前验证：{{ providerName }}</div>
            <button style="display: none;" id="captcha-button"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js/particles.min.js"></script>
<script src="https://static.geetest.com/v4/gt4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qmsg/dist/index.umd.min.js"></script>
<!-- 后端渲染区 -->
<script>
    const CAPTCHA_TYPE = "{$captcha}";
    const SERVER_NAME   = "{$serverName}";
</script>

<script>
    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                serverName: SERVER_NAME,
                loading: true,
                verified: false,
                errorMsg: '',        // 新增：错误信息
                countdown: 5,
                providerName: '加载中...',
                ip: '{$ip}', // 不要试图修改IP,否则将无法通过验证
                aliyunCaptcha: null,
                aliyunCaptchaButton: null,
            }
        },
        methods: {
            initCaptcha() {
                this.loading = true;
                this.verified = false;
                this.errorMsg = '';
                const box = document.getElementById('captcha-box');
                box.innerHTML = '';

                if (CAPTCHA_TYPE === 'google') {
                    this.providerName = 'Google reCAPTCHA v2';

                    const wrapper = document.createElement('div');
                    wrapper.id = 'google-recaptcha-wrapper';
                    box.appendChild(wrapper);

                    window.onRecaptchaLoad = () => {
                        grecaptcha.render('google-recaptcha-wrapper', {
                            sitekey: "{$reCaptcha['params']['site_key']}",
                            theme: 'dark',
                            callback: (token) => this.verifyGoogle(token),
                            'expired-callback': () => this.showError('验证码已过期，请重新验证'),
                            'error-callback': () => this.showError('加载失败，请检查网络后刷新页面')
                        });
                        this.loading = false;
                    };

                    const script = document.createElement('script');
                    script.src = 'https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit';
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                }

                else if (CAPTCHA_TYPE === 'geetest') {
                    this.providerName = '极验 GeeTest v4';
                    const captchaId = "{$geetest['params']['id']}";
                    const box = document.getElementById('captcha-box');
                    box.style.minHeight = '320px';
                    box.style.display = 'flex';
                    box.style.justifyContent = 'center';
                    box.style.alignItems = 'center';
                    box.style.padding = '20px 0';  // 额外上下内边距，让视觉更居中

                    // 创建一个有明确宽高的容器（官方最推荐的写法）
                    box.innerHTML = `
                        <div id="geetest-container"
                             style="width:100%; max-width:420px; margin:0 auto;">
                        </div>
                    `;
                    initGeetest4({
                        captchaId: captchaId,
                        product: 'float',
                        nativeButton: {
                            width: '100%',
                        }
                    }, (captcha) => {
                        captcha
                            .onReady(() => {

                            })
                            .onSuccess(async () => {
                                const result = await captcha.getValidate();
                                if (!result) {
                                    return alert('请完成验证');
                                }
                                await this.onSuccess('geetest', result);
                            })
                            .appendTo('#geetest-container')
                        ;
                    });
                }

                else if (CAPTCHA_TYPE === 'aliyun') {
                    this.providerName = '阿里云滑块验证';
                    this.aliyunCaptchaButton = document.getElementById('captcha-button');
                    const sceneId = "{$aliyun['params']['sceneId']}";
                    window.initAliyunCaptcha({
                        SceneId: sceneId,
                        mode: 'embed',
                        element: '#captcha-box',
                        button: '#captcha-button',
                        success: async (captchaVerifyParam) => {
                            await this.onSuccess('aliyun', captchaVerifyParam);
                        },
                        getInstance: this.getInstance,
                    });
                }
            },

            getInstance(instance) {
                this.aliyunCaptcha = instance;
            },

            // 统一错误显示方法
            showError(msg) {
                this.loading = false;
                this.errorMsg = msg;
                // 3秒后自动清除错误，方便重试
                setTimeout(() => { this.errorMsg = ''; }, 8000);
            },

            // Google 专用验证函数
            async verifyGoogle(token) {
                try {
                    const result = await this.botSentryVerify(this.ip, token);

                    if (result) {
                        this.verified = true;
                        this.startCountdown();
                        setTimeout(() => document.getElementById('captcha-box').style.display = 'none', 800);
                    } else {
                        grecaptcha.reset();
                        this.showError('验证失败：机器人检测未通过或IP被拒绝');
                    }
                } catch (err) {
                    grecaptcha.reset();
                    this.showError('网络错误：无法连接验证服务器');
                }
            },

            // 其他验证码成功回调（极验/阿里云）也建议改为：
            async onSuccess(provider, data) {
                Qmsg.warning('正在二次验证中,请耐心等待...')
                try {
                    const res = await axios.post('/api/callback', { type: provider, data });
                    if (res.data.code === 0) {
                        const result = await this.botSentryVerify(this.ip, res.data.data.token);
                        if (result) {
                            this.verified = true;
                            this.startCountdown();
                            setTimeout(() => document.getElementById('captcha-box').style.display = 'none', 800);
                        } else {
                            this.showError('验证失败,请刷新重试.');
                        }
                    } else {
                        this.showError(res.data.msg || '验证被拒绝');
                    }
                } catch (err) {
                    this.showError('服务器连接失败，请稍后重试');
                } finally {
                    setTimeout(() => document.getElementById('captcha-box').style.display = 'none', 800);
                }
            },

            retryCaptcha() {
                this.errorMsg = '';
                this.initCaptcha();
            },

            startCountdown() {
                const timer = setInterval(() => {
                    if (--this.countdown <= 0) {
                        clearInterval(timer);
                        this.countdown = '可关闭窗口';
                    }
                }, 1000);
            },

            /**
             * 向 BotSentry 提交人机验证
             * @param {string} ip 不要试图换IP，有访问IP验证
             * @param token
             * @returns {Promise<boolean>} true=验证通过，false=失败
             */
            async botSentryVerify(ip, token) {
                const form = new URLSearchParams();

                // IP 一定带上
                form.append('ip', ip);
                form.append('token', token);

                try {
                    const res = await axios({
                        method: 'POST',
                        url: 'https://cyberdevelopment.es/BotSentry/verify/verified.php',
                        data: form,
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        timeout: 12000
                    });

                    // BotSentry 成功返回纯文本 4
                    return String(res.data).trim() === '4';

                } catch (e) {
                    return false;   // 任何异常都视为失败
                }
            }
        },

        mounted() {
            this.initCaptcha();

            particlesJS('particles-js', {
                particles: {
                    number: { value: 130 },
                    color: { value: ['#8A2BE2','#00ffea','#ff00ff'] },
                    opacity: { value: 0.7, random: true },
                    size: { value: 4, random: true },
                    line_linked: { enable: true, distance: 160, color: '#8A2BE2', opacity: 0.5 },
                    move: { enable: true, speed: 2 }
                },
                interactivity: { events: { onhover: { enable: true, mode: 'repulse' } } }
            });
        },
        beforeUnmount() {
            this.aliyunCaptchaButton = null;
            document.getElementById('aliyunCaptcha-mask')?.remove();
            document.getElementById('aliyunCaptcha-window-popup')?.remove();
        }
    }).mount('#app');
</script>
<style>
    .fade-enter-active { transition: all 0.8s ease; }
    .fade-enter-from { opacity: 0; transform: translateY(20px); }
</style>
</body>
</html>